<!DOCTYPE html>
<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css"/>
  </head>
  <body>
  </script>
    <div class="grid" id="grid">
      <div class="header" id="header">
      </div>
      <div class="viewport" id="browser">
      </div>
      <div class="sidebar" id="sidebar">
        <div class="payload">current: <span id="current"></span></div>
        <div class="payload">target: <span id="target"></span></div>
        <table>
          <thead>
            <tr>
              <th>track id</th>
              <th>offset</th>
              <th>size</th>
              <th colspan="4">on/off</th>
            </tr>
          </thead>
          <tbody id="track-metadata">
          </tbody>
        </table>
        <table>
          <thead>
            <tr>
              <th>id</th>
              <th>state</th>
              <th>actions</th>
            </tr>
          </thead>
          <tbody id="focus-transcripts">            
          </tbody>
        </table>
        <div id="zmenu-click" class="payload" style="font-size: 10px"></div>
      </div>
      <div class="footer" id="footer">
      </div>
    </div>
    <script type="module">
      import { GenomeBrowser, default as init } from './pkg/peregrine_generic.js';
      init().then(function() {
        let genome_browser = new GenomeBrowser();
        genome_browser.go({
          backend_url: "http://127.0.0.1:3333/api/data http://127.0.0.1:3334/api/data",
          target_element_id: 'browser',
          'keys.debug-action': "Require(drag)-Click[2] Hold[3] HoldDrag[4] DoubleClick[7] 1[1] 2[2] 3[3] 4[4] 5[5] 6[6] 7[7] 8[8] 9[9] 0[0]",
          'keys.pixels-left': 'Shift-A[100] Alt-a[1000]',
          'keys.pixels-right': "MirrorRunningDrag Shift-D[100] Alt-d[1000]",
          'keys.pixels-in': "Shift-W[100]",
          'keys.pixels-out': "Shift-S[100] Wheel",
          "keys.pull-left": "a ArrowLeft",
          "keys.pull-right": "d ArrowRight",
          "keys.pull-in": "w ArrowUp",
          "keys.pull-out": "s ArrowDown",
          "zoom.goto.rho": "1.41",
          "zoom.goto.v": "0.003",
        });
        var seen_transcripts = {};
        var shown_transcripts = {};
        var labels = {};
        var tr_labels = {};
        var sv_labels = {};
        var nm_labels = {};
        var tracks_on = {};

        function tr_all(yn) {
          for(const tr in seen_transcripts) {
            if(yn) {
              shown_transcripts[tr] = 1;
            } else {
              delete shown_transcripts[tr];
            }
          }
          genome_browser.switch(["track","focus","enabled-transcripts"],Object.keys(shown_transcripts));
        }

        function toggle_track(track_name) {
          console.log('track_name', track_name);
          let cur = tracks_on[track_name];
          if(cur!==true && cur!==false) { cur = true; }
          let value = !cur;
          tracks_on[track_name] = value;
          if(value) {
            if (track_name.startsWith('variant')) {
              genome_browser.switch(["track", 'expand-variation', track_name],true);
            } else {
              genome_browser.switch(["track",track_name],true);
            }
          } else {
            if (track_name.startsWith('variant')) {
              genome_browser.switch(["track", 'expand-variation', track_name],false);
            } else {
              genome_browser.switch(["track",track_name],false);
            }
          }
        }
        function toggle_label(track_name) {
          let cur = labels[track_name];
          if(cur!==true && cur!==false) { cur = true; }
          let value = !cur;
          labels[track_name] = value;
          if(value) {
            genome_browser.switch(["track",track_name,"label"],true);
          } else {
            genome_browser.switch(["track",track_name,"label"],false);
          }
        }
        function toggle_tr_label(track_name) {
          let cur = tr_labels[track_name];
          if(cur!==true && cur!==false) { cur = false; }
          let value = !cur;
          tr_labels[track_name] = value;
          if(value) {
            genome_browser.switch(["track",track_name,"transcript-label"],true);
          } else {
            genome_browser.switch(["track",track_name,"transcript-label"],false);
          }
        }
        function toggle_name(track_name) {
          console.log('track_name', track_name);
          let cur = nm_labels[track_name];
          if(cur!==true && cur!==false) { cur = true; }
          let value = !cur;
          nm_labels[track_name] = value;
          console.log('value', value);
          if(value) {
            if (track_name.startsWith('variant')) {
              genome_browser.switch(["track", "expand-variation", track_name,"name"],true);
            } else {
              genome_browser.switch(["track",track_name,"name"],true);
            }
          } else {
            if (track_name.startsWith('variant')) {
              genome_browser.switch(["track", "expand-variation", track_name, "name"], false);
            } else {
              genome_browser.switch(["track",track_name,"name"],false);
            }
          }
        }
        let all_tracks = {};
        let current_span = document.getElementById("current");
        let target_span = document.getElementById("target");
        genome_browser.set_message_reporter(function(kind,...more) {
          if(kind=="error") {
              console.error(more[0]);
          } else if(kind=="current_position") {
            let currentPosition = more[0];
              current_span.innerText = `${currentPosition.stick}:${currentPosition.start}-${currentPosition.end}`;
          } else if(kind=="target_position") {
              let targetPosition = more[0];
              target_span.innerText = `${targetPosition.stick}:${targetPosition.start}-${targetPosition.end}`;
          } else if(kind=="endstops") {
              console.log("endstops: " + more[0])
          } else if(kind=="track_summary") {
            let tbody = document.getElementById("track-metadata");
            for(const track of more[0].summary) {
                if(track.type != "track") { continue; } /* don't care */
                all_tracks[track["switch-id"]] = track;
            }
            tbody.innerHTML = "";
            for(const track_name in all_tracks) {
                let track = all_tracks[track_name];
                if(track.type != "track") { continue; } /* don't care */
                if('all-transcripts' in track) {
                  let all = track['all-transcripts'];
                  let new_seen_transcripts = {};
                  for(let i=0;i<all.length;i++) {
                    new_seen_transcripts[all[i]] = 1;
                  }
                  let pruned = false;
                  for(const old_seen in seen_transcripts) {
                    if(!new_seen_transcripts[old_seen]) { pruned = true; }
                  }
                  if(pruned) {
                    genome_browser.switch(["track","focus","enabled-transcripts"],null);
                  }
                  seen_transcripts = new_seen_transcripts;
                  if('transcripts-shown' in track) {
                    let shown = track['transcripts-shown'];
                    shown_transcripts = {};
                    for(const trid of shown) {
                      if(seen_transcripts[trid]) {
                        shown_transcripts[trid] = 1;
                      }
                    }
                  }
                }
                let tr = document.createElement("tr");
                let data = [track["switch-id"],track.offset,track.height];
                for(const text of data) {
                  let td = document.createElement("td");
                  td.innerText = text;
                  tr.appendChild(td);
                }
                let td1 = document.createElement("td");
                td1.innerHTML = "<a title='Toggle track'>üëÅÔ∏è</a>";
                td1.onclick = function() { toggle_track(track['switch-id']) };
                let td4 = document.createElement("td");
                let td3 = document.createElement("td");
                td3.innerHTML = "<a title='Toggle track name' class='lbl'>üè∑Ô∏èn</a>";
                td3.onclick = function() { toggle_name(track['switch-id']) };
                tr.appendChild(td1);
                tr.appendChild(td3);
                tr.appendChild(td4);
                tbody.appendChild(tr);
              }
          } else if(kind=="hotspot") {
            let zmenu_data_el = document.getElementById("zmenu-click");
            if(more[0].variety[0].type == "lozenge") {
              let obj = more[0].content[0];
              if(obj.focus) {
                tr_all(!obj.currently_all);
              }
            }
            let zmenu_data = more[0];
            zmenu_data_el.innerText = JSON.stringify(zmenu_data);
          }
        });

        /* Set startup view/location */
        genome_browser.set_stick("a7335667-93e7-11ec-a39d-005056b38ce3:13");
        genome_browser.switch(["track","gene-pc-fwd"],true);
        genome_browser.switch(["track","gene-pc-fwd","label"],true);
        genome_browser.switch(["track","gene-pc-fwd","name"],true);
        genome_browser.switch(["track","gc"],true);
        genome_browser.switch(["track","gc","name"],true);
        genome_browser.switch(["track","contig"],true);
        genome_browser.switch(["track","contig","name"],true);
        genome_browser.switch(["track","expand-variation"],true); // <-- NOTE THIS. DOES THIS MEAN WE HAVE TO EXPLICITLY ENABLE THE EXPANSION NODE?
        genome_browser.switch(["ruler"],true);
        genome_browser.switch(["ruler","one_based"],true);




        genome_browser.switch(["track", "expand-variation", "variant-dbsnp"],true);
        genome_browser.switch(["track", "expand-variation", "variant-1000genomes"],true);
        genome_browser.goto(31915000, 31970000);

      });
    </script>
  </body>
</html>
