stages:
  - build_docker
  - deploy

# Builds wasm files
.build_wasm:
  stage: build_docker
  image: rust:1.57

  before_script:
    - cd peregrine-ensembl
    - curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

  script:
    - RUSTFLAGS="--cfg=console --cfg=force_show_incoming"
    - wasm-pack build --target web --release
    - ls pkg/

  after_script:
    - echo "BUILD_JOB_ID=${CI_JOB_ID}" >> build_wasm.env

  rules:
    - if: '$CI_DEPLOY_FREEZE == null && $CI_COMMIT_BRANCH == "multi-project-build"'
      changes: 
        - peregrine-ensembl/*

  artifacts:
    name: build_wasm_artifacts
    paths:
      - pkg/
    reports:
      dotenv: build_wasm.env

Build-WASM:
  extends: .build_wasm

# Build node package
Build-npm:
  stage: deploy
  variables:
    UPSTREAM_BRANCH: $CI_COMMIT_REF_NAME
    WASM_BUILD_JOB_ID: ${BUILD_JOB_ID}

  trigger:
    project: ensembl-web/ensembl-genome-browser
    branch: multi-project-pipeline

  rules:
    - if: '$CI_DEPLOY_FREEZE == null && $CI_COMMIT_BRANCH == "multi-project-build"'
      changes: 
        - peregrine-ensembl/*

